<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: node-positioning/justified.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: node-positioning/justified.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Original, full-width node positioning.
 *
 * Uses spacing and whitespace fraction to position nodes within layers.
 *
 * @module node-positioning/justified
 */

import d3 from 'd3';


export default function justifiedPositioning() {
  // XXX what about bands?

  let size = [1, 1],
      scale = null,
      separation = function(a, b) { return 1; },
      whitespace = 0.5;

  function position(G, order) {
    if (scale === null) position.scaleToFit(G, order);

    // set node and edge sizes
    setNodeEdgeHeights(G, scale);

    // position nodes in each layer
    // XXX bands
    const margin = whitespace * size[1] / 5;
    const dx = size[0] / (order.length - 1);
    let x = 0;
    order.forEach(rank => {
      const height = size[1] - 2*margin;
      const total = d3.sum(rank, u => G.node(u).dy);
      const gaps = rank.map((u, i) => {
        const node = G.node(u);
        if (!node.value) return 0;
        return rank[i+1] ? separation(rank[i], rank[i+1]) : 0;
      });
      const space = Math.max(0, height - total);
      const kg = d3.sum(gaps) ? space / d3.sum(gaps) : 0;

      // if (rank.length === 1) {
      //   y += space / 2;
      // }

      const isFirst = true,
            isLast = true;  // XXX bands

      let y = margin;

      let prevGap = isFirst ? Number.MAX_VALUE : 0;  // edge of graph
      rank.forEach((u, i) => {
        const node = G.node(u);
        node.x = x;
        node.y = y;
        node.spaceAbove = prevGap;
        node.spaceBelow = gaps[i] * kg;
        y += node.dy + node.spaceBelow;
        prevGap = node.spaceBelow;
      });
      G.node(rank[rank.length - 1]).spaceBelow =
        isLast ? Number.MAX_VALUE : 0;  // edge of graph

      x += dx;
    });
  }

  position.scaleToFit = function(G, order) {
    setNodeValues(G);

    const maxValue = d3.max(order, rank => d3.sum(rank, u => G.node(u).value));
    if (maxValue &lt;= 0) throw Error('no value');

    scale = size[1] / maxValue;
    if (whitespace != 1) scale *= (1 - whitespace);
  };

  position.size = function(x) {
    if (!arguments.length) return size;
    size = x;
    return position;
  };

  position.separation = function(x) {
    if (!arguments.length) return separation;
    separation = d3.functor(x);
    return position;
  };

  position.whitespace = function(x) {
    if (!arguments.length) return whitespace;
    whitespace = x;
    return position;
  };

  position.scale = function(x) {
    if (!arguments.length) return scale;
    scale = x;
    return position;
  };

  return position;
}


function setNodeValues(G) {
  G.nodes().forEach(n => {
    const incoming = d3.sum(G.inEdges(n), e => G.edge(e).value),
          outgoing = d3.sum(G.outEdges(n), e => G.edge(e).value);
    if (G.node(n) === undefined) G.setNode(n, {});
    G.node(n).value = Math.max(incoming, outgoing);
  });
}


function setNodeEdgeHeights(G, scale) {
  G.nodes().forEach(n => {
    const node = G.node(n);
    node.dy = node.value * scale;
  });

  G.edges().forEach(e => {
    const edge = G.edge(e);
    edge.dy = edge.value * scale;
  });
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-edge-ordering.html">edge-ordering</a></li><li><a href="module-edge-positioning.html">edge-positioning</a></li><li><a href="module-layout.html">layout</a></li><li><a href="module-node-ordering.html">node-ordering</a></li><li><a href="module-node-ordering_count-crossings.html">node-ordering/count-crossings</a></li><li><a href="module-node-positioning_justified.html">node-positioning/justified</a></li></ul><h3>Classes</h3><ul><li><a href="module-layout.html#~sankeyLayout">sankeyLayout</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Mar 03 2016 09:48:43 GMT+0000 (GMT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
